# Enable rewriting
RewriteEngine On

# Set base directory
RewriteBase /

# If the request is for an actual file or directory that exists in the root, serve it directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Otherwise, rewrite all requests to the public directory
# But don't show "public" in the URL
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /public/([^\ ]*)\ HTTP/
RewriteRule ^public/(.*)$ /$1 [R=301,L]

# Special handling for Cloudflare Turnstile requests - pass through directly to avoid rewriting
RewriteCond %{HTTP_REFERER} ^https?://(www\.)?automaticpetfeeder\.redwancodes\.com
RewriteCond %{REQUEST_URI} ^/cdn-cgi/challenge-platform/
RewriteRule ^ - [L]

# Special handling for Turnstile API verification endpoint
RewriteRule ^api/turnstile-verify.php$ public/api/turnstile-verify.php [L]

# Internally rewrite requests to the public directory
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ public/$1 [L]

# Handle the case where someone requests the root
RewriteRule ^$ public/index.html [L]

# Add special CORS headers for Cloudflare Turnstile
<IfModule mod_headers.c>
    # Enable CORS for Cloudflare Turnstile and API requests
    <FilesMatch "\.(html|js|php)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type"
        
        # Handle preflight OPTIONS requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </FilesMatch>
    
    # Set specific header for Turnstile domain
    <FilesMatch "turnstile-verify\.php$">
        Header set Access-Control-Allow-Origin "https://challenges.cloudflare.com"
    </FilesMatch>
</IfModule>